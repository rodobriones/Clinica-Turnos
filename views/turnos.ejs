<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Turnos</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<h1>Listado de Turnos</h1>

<table>
<thead>
<tr>
  <th>Turno</th>
  <th>Paciente</th>
  <th>Clínica</th>
  <th>Hora</th>
  <th></th>
</tr>
</thead>
<tbody>
<% turnos.forEach(t => { %>
<tr>
  <td><%= t.numero_turno_clinica %></td>
  <td><%= t.paciente %></td>
  <td><%= t.clinica %></td>
  <td><%= t.fecha_hora %></td>
  <td>
    <button class="btn-reasignar" data-id="<%= t.id %>">
      Reasignar
    </button>
  </td>
</tr>
<% }) %>
</tbody>
</table>


<!-- Overlay oscuro -->
<div id="overlay" class="overlay oculto"></div>

<!-- Modal -->
<div id="modal" class="modal oculto">
  <div class="modal-card">

    <div class="modal-header">
      <h2>Reasignar turno</h2>
      <button type="button" id="btn-cerrar-x" class="btn-cerrar-x">&times;</button>
    </div>

    <form id="form">
      <input type="hidden" id="turno_id">

      <div class="form-group">
        <label for="clinica">Nueva clínica:</label>
        <select id="clinica" required>
          <option value="">Seleccione una clínica</option>
          <% clinicas.forEach(c => { %>
            <option value="<%= c.id %>"><%= c.nombre %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-group">
        <label for="motivo">Motivo de la reasignación:</label>
        <textarea id="motivo" rows="4" required
          placeholder="Explique por qué se reasigna el turno (saturación, criterio médico, etc.)"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" id="cerrar" class="btn-secundario">Cancelar</button>
        <button type="submit" class="btn-primario">Guardar</button>
      </div>
    </form>

  </div>
</div>

<!-- Toast (notificación) -->
<div id="toast" class="toast oculto"></div>

<script>
  const modal = document.getElementById('modal');
  const overlay = document.getElementById('overlay');
  const btnCerrar = document.getElementById('cerrar');
  const btnCerrarX = document.getElementById('btn-cerrar-x');
  const form = document.getElementById('form');
  const inputTurnoId = document.getElementById('turno_id');

  // Toast
  const toast = document.getElementById('toast');
  let toastTimeout;

  function mostrarToast(mensaje, tipo = 'exito') {
  if (toastTimeout) clearTimeout(toastTimeout);

  toast.textContent = mensaje;

  // No ocultar por error
  toast.classList.remove('oculto');
  toast.classList.remove('exito', 'error', 'mostrar');

  toast.classList.add(tipo === 'error' ? 'error' : 'exito');

  // Trigger animation
  void toast.offsetWidth;
  toast.classList.add('mostrar');

  toastTimeout = setTimeout(() => {
    toast.classList.remove('mostrar');
  }, 20000);
}


  function abrirModal(turnoId) {
    inputTurnoId.value = turnoId;
    document.getElementById('clinica').value = "";
    document.getElementById('motivo').value = "";
    modal.classList.remove('oculto');
    overlay.classList.remove('oculto');
  }

  function cerrarModal() {
    modal.classList.add('oculto');
    overlay.classList.add('oculto');
  }

  // Abrir modal
  document.querySelectorAll('.btn-reasignar').forEach(btn => {
    btn.addEventListener('click', () => abrirModal(btn.dataset.id));
  });

  // Cerrar modal
  btnCerrar.addEventListener('click', cerrarModal);
  btnCerrarX.addEventListener('click', cerrarModal);
  overlay.addEventListener('click', cerrarModal);

  // Guardar reasignación
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = inputTurnoId.value;
    const clinica = document.getElementById('clinica').value;
    const motivo = document.getElementById('motivo').value.trim();

    if (!clinica || !motivo) {
      mostrarToast("Debe seleccionar una clínica y escribir el motivo.", "error");
      return;
    }

    const resp = await fetch(`/turnos/${id}/reasignar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ clinica_nueva_id: clinica, motivo })
    });

    const data = await resp.json();

    if (data.ok) {
      mostrarToast("Turno reasignado correctamente.", "exito");
      cerrarModal();
      setTimeout(() => location.reload(), 1200);
    } else {
      mostrarToast(data.message || "Error al reasignar.", "error");
    }
  });
</script>

</body>
</html>
